---
description: Business logic, user personas, and success metrics for CSIQ-Microservice
globs: ["service-*/**/*.js", "Library/**/*.js", "**/controllers/**/*.js", "**/services/**/*.js"]
alwaysApply: false
priority: high
---

# Business Logic & Success Metrics

## Project Orbit Engineering: Quality × Speed

- **Traditional Engineering:** Quality vs Speed trade-off → Technical debt accumulation.
- **Project Orbit Engineering:** Quality × Speed multiplication → Sustainable engineering velocity.
- **Result:** Fast delivery AND high quality simultaneously.

## User Personas & Architecture

- **HTTP/API Services** (e.g., `service-cs-one-api`): Follow **Routes → Controller → Service → Repository**. Routes in `routes/routes.js`; Controllers for validation and HTTP; Services for business logic; Repositories for database queries.
- **Event-Driven Services** (e.g., `service-csiq-cdr`): Logic self-contained; use shared `Library/RabbitMQ/RabbitMQ.js` for consume/publish.
- **Scheduled Tasks:** Do NOT implement custom cron; delegate to **`service-csiq-schedule`** (single source of truth).
- **Shared Libraries:** Use `Library/` (e.g., `Library/MongoDB/MongoDB.js`, `Library/Mysql/Db.js`) for all DB, queue, and cache interactions.

## Success Metrics

- **Quality Metrics:** Zero HIPAA violations; 50% improvement in system performance; 99.9% regulatory audit success rate; 3x improvement in customer satisfaction.
- **Microservice Targets:** Database query time < 300ms; BigQuery < 5s; Cache hit rate > 80%; Memory optimized for thousands of dental practices; HIPAA 100% validation; Audit trail 100% for all PHI access.

---

## HIPAA Compliance: PHI Logging Restrictions

**Rule:** Do NOT log PHI (patient health information) in success-path logs

**PHI Identifiers Include:**
- Patient phone numbers
- Appointment IDs
- Patient names
- Medical record numbers
- Any other patient identifiers per HIPAA

**Logging Guidelines:**

✅ **Allowed (Success Path):**
```javascript
console.log(`Processing callId: ${callId}, appointmentCount: ${count}`);
console.log(`Patient search found: ${results.length} results`);
console.log(`[Service]::CallId: ${callId}::Operation successful`);
```

❌ **NOT Allowed (Success Path):**
```javascript
console.log(`appointmentIds: ${JSON.stringify(appointmentIds)}`);  // PHI
console.log(`Patient phone: ${patientNumber}`);  // PHI
console.log(`Full payload:`, payload);  // May contain PHI
console.log(`Patient data:`, JSON.stringify(patientData));  // PHI
```

**Exception Paths:**
- **Dead Letter Collection:** Can store full payload (restricted access for debugging)
- **Google Space Alerts:** Include callId + error message, NOT PHI details
- **Debug Logs (Development Only):** Can include PHI, MUST be disabled in production

**Enforcement:** Code reviewer checks for PHI in logs during review phase

**Related Services:**
- service-csiq-appointment-bigquery (CSIQ-13534)
- service-csiq-patient-appointment-linking (CSIQ-13534)

**Added:** 2026-02-16 (CSIQ-13534)
